<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vote Status & Winners</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hover-custom-blue:hover {
            background-color: #66cc99;
        }
    </style>
</head>
<body class="bg-blue-200 font-sans flex flex-col min-h-screen">
    <!-- Sidebar -->
    <div class="bg-gray-300 text-black h-full w-64 fixed left-0 top-0 overflow-y-auto">
        <div class="px-11 py-2 w-full flex justify-center">
            <img src="l3.png" alt="Logo" class="w-32 h-auto object-contain" />
        </div>
        <ul id="sidebarMenu" class="mt-8">
            <li class="px-5 py-3 hover:bg-gray-400"><a href="admin_dashboard.html" class="block">Dashboard</a></li>
            <li class="px-5 py-3 hover:bg-gray-400"><a href="approve_voter.html" class="block">Approve Voter Registration</a></li>
            <li class="px-5 py-3 hover:bg-gray-400"><a href="modify_voter_info.html" class="block">Modify Voter Information</a></li>
            <li class="px-5 py-3 hover:bg-gray-400"><a href="modify_candidate_list.html" class="block">Add Candidate </a></li>
            <li class="px-5 py-3 hover:bg-gray-400"><a href="result_publish.html" class="block">Publish Result</a></li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="ml-64 p-8 flex-grow">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold">Vote Status & Winners</h1>
        </div>

        <!-- Vote Status Section -->
        <section class="mb-8">
            <h2 class="text-2xl font-semibold mb-4">Vote Status Report</h2>
            <div id="vote-status-container" class="bg-white shadow-md p-4 rounded"></div>
            <button id="save-invalid-vote-btn" class="mt-4 bg-green-500 text-white py-2 px-4 rounded hover-custom-blue">Save Vote Status Data</button>
        </section>

        <!-- Vote Winners Section -->
        <section>
            <h2 class="text-2xl font-semibold mb-4">Vote Winners</h2>
            <div id="vote-winners-container" class="bg-white shadow-md p-4 rounded"></div>
            <button id="publish-results-btn" class="mt-4 bg-blue-500 text-white py-2 px-4 rounded hover-custom-blue">Publish Results</button>
            <h1> </h1>
            <br>
            <br>
        </section>
    </div>
    <footer style="background-color: #42476d" class="text-white py-2.5 fixed bottom-0 w-full">
        <div class="container mx-auto text-center">
          <p>&copy; 2024 Online Vote. All rights reserved.</p>
        </div>
    </footer>
  
    <script>
        async function fetchElectionId() {
            try {
                const response = await fetch('http://localhost:3000/get-election-id');
                if (!response.ok) throw new Error('Failed to fetch election ID');
                const data = await response.json();
                return data.electionId;
            } catch (error) {
                console.error(error);
                return null;
            }
        }

        async function fetchData(endpoint, electionId) {
            try {
                const response = await fetch(`http://localhost:3000/${endpoint}?electionId=${electionId}`);
                if (!response.ok) throw new Error(`Failed to fetch ${endpoint}`);
                return await response.json();
            } catch (error) {
                console.error(error);
                return null;
            }
        }

        async function displayVoteStatus() {
            const electionId = await fetchElectionId();
            if (!electionId) {
                document.getElementById('vote-status-container').innerHTML = '<p>No election ID found.</p>';
                return;
            }

            const voteStatus = await fetchData('vote-status', electionId);
            if (voteStatus) renderTable('vote-status-container', voteStatus, ['BallotNo', 'designationName', 'voteStatus']);
        }

        async function displayVoteWinners() {
            const electionId = await fetchElectionId();
            if (!electionId) {
                document.getElementById('vote-winners-container').innerHTML = '<p>No election ID found.</p>';
                return;
            }

            const voteWinners = await fetchData('vote-winners', electionId);
            if (voteWinners) renderTable('vote-winners-container', voteWinners, ['candidateName', 'designationName', 'voteCount', 'status']);
        }

        function renderTable(containerId, data, columns) {
            const container = document.getElementById(containerId);
            if (!data || data.length === 0) {
                container.innerHTML = '<p>No data available.</p>';
                return;
            }

            let table = `<table class="table-auto w-full border-collapse border border-gray-400 rounded-md">
                <thead class="bg-gray-200">
                    <tr>`;
            columns.forEach(col => table += `<th class="border border-gray-400 py-2 px-4">${col}</th>`);
            table += `</tr>
                </thead>
                <tbody>`;
            data.forEach(row => {
                table += `<tr class="text-center hover:bg-gray-100">`;
                columns.forEach(col => table += `<td class="border border-gray-400 py-2 px-4">${row[col]}</td>`);
                table += `</tr>`;
            });
            table += `</tbody>
            </table>`;
            container.innerHTML = table;
        }

        async function saveInvalidVoteData() {
            const electionId = await fetchElectionId();
            if (!electionId) {
                alert('No election ID found.');
                return;
            }

            const table = document.getElementById('vote-status-container').querySelector('table');
            if (!table) {
                alert('No data to save.');
                return;
            }

            const rows = table.querySelectorAll('tbody tr');
            const invalidVotes = [];
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                invalidVotes.push({
                    BallotNo: cells[0].textContent,
                    designationName: cells[1].textContent,
                    voteStatus: cells[2].textContent,
                    electionId: electionId
                });
            });

            try {
                const response = await fetch('http://localhost:3000/save-invalid-vote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(invalidVotes)
                });
                if (!response.ok) throw new Error('Failed to save data');
                alert('Votes status saved successfully!');
            } catch (error) {
                console.error(error);
                alert('Error saving data.');
            }
        }

        async function publishResults() {
            const electionId = await fetchElectionId();
            if (!electionId) {
                alert('No election ID found. Unable to publish results.');
                return;
            }

            try {
                const response = await fetch('http://localhost:3000/publish-results', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ electionId })
                });

                if (!response.ok) throw new Error('Failed to publish results');
                const result = await response.json();
                alert(result.message);
            } catch (error) {
                console.error('Error publishing results:', error);
                alert('Error publishing results. Please try again later.');
            }
        }

        document.getElementById('save-invalid-vote-btn').addEventListener('click', saveInvalidVoteData);
        document.getElementById('publish-results-btn').addEventListener('click', publishResults);

        window.onload = () => {
            displayVoteStatus();
            displayVoteWinners();
        };
    </script>
</body>
</html>
