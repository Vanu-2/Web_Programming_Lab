<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modify Voter Information</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 font-sans flex flex-col min-h-screen">

    <!-- Sidebar -->
    <div class="bg-gray-300 text-black h-full w-64 fixed left-0 top-0 overflow-y-auto">
      <div class="px-11 py-2 w-full flex justify-center">
          <img src="l3.png" alt="Logo" class="w-full h-auto w-50 object-contain" />
      </div>
      <ul id="sidebarMenu" class="mt-8">
          <li class="px-5 py-3 hover:bg-gray-400">
              <a href="admin_dashboard.html" class="block">Dashboard</a>
          </li>
          <li class="px-5 py-3 hover:bg-gray-400">
              <a href="approve_voter.html" class="block">Approve Voter Registration</a>
          </li>
          <li class="px-5 py-3 hover:bg-gray-400">
              <a href="modify_voter_info.html" class="block">Modify Voter Information</a>
          </li>
          <li class="px-5 py-3 hover:bg-gray-400">
              <a href="modify_candidate_list.html" class="block">Modify Candidate List</a>
          </li>
          <li class="px-5 py-3 hover:bg-gray-400">
              <a href="result_publish.html" class="block">Publish result</a>
          </li>
      </ul>
  </div>

    <!-- Main Content -->
    <div class="ml-64 p-8 flex-grow">
        <h1 class="text-3xl font-bold mb-6">Modify Voter Information</h1>
        <table class="min-w-full bg-white rounded-lg shadow">
            <thead class="bg-gray-200">
                <tr>
                    <th class="py-3 px-4 text-left">Username</th>
                    <th class="py-3 px-4 text-left">Email</th>
                    <th class="py-3 px-4 text-left">Address</th>
                    <th class="py-3 px-4 text-left">Status</th>
                    <th class="py-3 px-4 text-left">Actions</th>
                </tr>
            </thead>
            <tbody id="voterTableBody">
                <!-- Voter data will be dynamically inserted here -->
            </tbody>
        </table>
    </div>

    <!-- Footer -->
    <footer style="background-color: #42476d;" class="text-white py-4 fixed bottom-0 w-full">
        <div class="container mx-auto text-center">
            <p>&copy; 2024 Online Vote. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // Fetch voters and display in table
        document.addEventListener("DOMContentLoaded", () => {
            fetch("/getVoters")
                .then(response => response.json())
                .then(voters => {
                    const tableBody = document.getElementById("voterTableBody");

                    voters.forEach(voter => {
                        const row = document.createElement("tr");
                        row.classList.add("border-t");

                        row.innerHTML = `
                            <td class="py-3 px-4">
                                <span class="voter-username">${voter.username}</span>
                                <input type="text" class="edit-voter-username hidden border border-gray-300 rounded px-2 py-1" value="${voter.username}" />
                            </td>
                            <td class="py-3 px-4">
                                <span class="voter-email">${voter.v_email}</span>
                                <input type="email" class="edit-voter-email hidden border border-gray-300 rounded px-2 py-1" value="${voter.v_email}" />
                            </td>
                            <td class="py-3 px-4">
                                <span class="voter-address">${voter.address}</span>
                                <input type="text" class="edit-voter-address hidden border border-gray-300 rounded px-2 py-1" value="${voter.address}" />
                            </td>
                            <td class="py-3 px-4">
                                <span class="voter-status">${voter.status}</span>
                                <select class="edit-voter-status hidden border border-gray-300 rounded px-2 py-1">
                                    <option value="pending" ${voter.status === 'pending' ? 'selected' : ''}>Pending</option>
                                    <option value="approved" ${voter.status === 'approved' ? 'selected' : ''}>Approved</option>
                                </select>
                            </td>
                            <td class="py-3 px-4">
                                <button class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-700 update-btn">Update</button>
                                <button class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-700 hidden save-btn">Save</button>
                                <button class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-700 delete-btn">Delete</button>
                            </td>
                        `;

                        tableBody.appendChild(row);

                        const updateBtn = row.querySelector(".update-btn");
                        const saveBtn = row.querySelector(".save-btn");
                        const deleteBtn = row.querySelector(".delete-btn");

                        const usernameSpan = row.querySelector(".voter-username");
                        const emailSpan = row.querySelector(".voter-email");
                        const addressSpan = row.querySelector(".voter-address");
                        const statusSpan = row.querySelector(".voter-status");

                        const usernameInput = row.querySelector(".edit-voter-username");
                        const emailInput = row.querySelector(".edit-voter-email");
                        const addressInput = row.querySelector(".edit-voter-address");
                        const statusInput = row.querySelector(".edit-voter-status");

                        updateBtn.addEventListener("click", () => {
                            // Hide the span and show the input fields
                            usernameSpan.classList.add("hidden");
                            emailSpan.classList.add("hidden");
                            addressSpan.classList.add("hidden");
                            statusSpan.classList.add("hidden");

                            usernameInput.classList.remove("hidden");
                            emailInput.classList.remove("hidden");
                            addressInput.classList.remove("hidden");
                            statusInput.classList.remove("hidden");

                            // Show save button, hide update button
                            updateBtn.classList.add("hidden");
                            saveBtn.classList.remove("hidden");
                        });

                        saveBtn.addEventListener("click", () => {
                            const updatedUsername = usernameInput.value;
                            const updatedEmail = emailInput.value;
                            const updatedAddress = addressInput.value;
                            const updatedStatus = statusInput.value;

                            fetch("/updateVoter", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ 
                                    v_email: voter.v_email,
                                    username: updatedUsername,
                                    v_email: updatedEmail,
                                    address: updatedAddress,
                                    status: updatedStatus
                                })
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        // Update the displayed values
                                        usernameSpan.textContent = updatedUsername;
                                        emailSpan.textContent = updatedEmail;
                                        addressSpan.textContent = updatedAddress;
                                        statusSpan.textContent = updatedStatus;

                                        // Hide input fields, show the updated values
                                        usernameSpan.classList.remove("hidden");
                                        emailSpan.classList.remove("hidden");
                                        addressSpan.classList.remove("hidden");
                                        statusSpan.classList.remove("hidden");

                                        usernameInput.classList.add("hidden");
                                        emailInput.classList.add("hidden");
                                        addressInput.classList.add("hidden");
                                        statusInput.classList.add("hidden");

                                        // Show update button, hide save button
                                        updateBtn.classList.remove("hidden");
                                        saveBtn.classList.add("hidden");
                                    } else {
                                        alert("Update failed.");
                                    }
                                });
                        });

                        deleteBtn.addEventListener("click", () => {
                            if (confirm(`Are you sure to delete ${voter.username}?`)) {
                                fetch("/deleteVoter", {
                                    method: "POST",
                                    headers: { "Content-Type": "application/json" },
                                    body: JSON.stringify({ v_email: voter.v_email })
                                })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.success) {
                                            row.remove();
                                        } else {
                                            alert("Failed to delete voter.");
                                        }
                                    });
                            }
                        });
                    });
                });
        });
    </script>
</body>

</html>
